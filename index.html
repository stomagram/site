<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Stomagram</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; color: #fff; overflow: hidden; }
        
        #main-content { display: none; }
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 9999; opacity: 1; transition: opacity 0.5s; }
        #preloader.hidden { opacity: 0; visibility: hidden; }
        .loader-content { text-align: center; }
        .loader-content p { font-size: 16px; font-weight: 600; margin-bottom: 20px; letter-spacing: 2px; }
        #loading-tip { min-height: 40px; margin: 15px auto; max-width: 80%; color: #a8a8a8; font-size: 13px; font-style: italic; transition: opacity 0.5s; }
        #loading-tip strong { color: #fff; font-weight: 600; display: block; margin-bottom: 3px; }
        .loader-dots { display: flex; justify-content: center; gap: 10px; }
        .loader-dots div { width: 10px; height: 10px; background: #0095f6; border-radius: 50%; animation: bounce 1.2s infinite ease-in-out both; }
        .loader-dots div:nth-child(2) { animation-delay: -0.4s; }
        .loader-dots div:nth-child(3) { animation-delay: -0.8s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        #offline-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #ed4956; color: #fff; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; z-index: 10000; }
        
        .container { height: 100vh; display: flex; flex-direction: column; }
        .header { display: flex; align-items: center; padding: 10px 16px; background: #000; border-bottom: 1px solid #262626; position: relative; z-index: 50; }
        .time { font-size: 15px; font-weight: 600; margin-right: 15px; }
        .producer { font-size: 13px; color: #a8a8a8; flex-grow: 1; }
        .sound-btn { position: absolute; right: 16px; background: none; border: none; color: #fff; font-size: 20px; cursor: pointer; padding: 8px; }
        
        .posts-container { flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch; padding-bottom: 60px; }
        .posts-container::-webkit-scrollbar { display: none; }
        
        .post { display: flex; flex-direction: column; background: #000; }
        .post-header { display: flex; align-items: center; padding: 8px 16px; gap: 12px; }
        .post-avatar { width: 32px; height: 32px; border-radius: 50%; background: #333; border: 2px solid #555; background-size: cover; background-position: center; }
        .post-info { flex: 1; }
        .post-username { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .follow-btn { background: none; border: none; color: #0095f6; font-weight: 700; font-size: 14px; cursor: pointer; margin-left: 8px; padding: 0; }
        .follow-btn.following { color: #a8a8a8; font-weight: 600; }
        .verified { color: #0095f6; }
        .post-subtitle { font-size: 12px; color: #a8a8a8; }
        .post-menu { font-size: 24px; cursor: pointer; }
        .post-content { position: relative; width: 100%; min-height: 200px; max-height: 80vh; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .post-image { width: 100%; height: auto; object-fit: contain; }
        .post-actions { display: flex; align-items: center; padding: 2px 16px; gap: 16px; }
        .action-group { display: flex; gap: 16px; flex: 1; }
        .action-btn { background: none; border: none; color: #fff; font-size: 26px; cursor: pointer; padding: 8px; }
        .action-btn.liked { color: #ed4956; }
        .post-likes { padding: 0 16px 4px; font-size: 14px; font-weight: 600; }
        .post-caption { padding: 0 16px 8px; font-size: 14px; }
        .username-caption { font-weight: 600; margin-right: 6px; }
        .post-comments { padding: 0 16px 8px; font-size: 14px; color: #a8a8a8; }
        .post-time { padding: 0 16px 8px; font-size: 12px; color: #a8a8a8; border-bottom: 1px solid #262626; }
        .read-more-btn { color: #a8a8a8; font-weight: 500; margin-left: 5px; cursor: pointer; user-select: none; display: inline; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; padding-bottom: env(safe-area-inset-bottom); display: flex; align-items: center; justify-content: space-around; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(12px); z-index: 100; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; padding: 8px 16px; }
        .nav-btn.active { color: #0095f6; }
        
        /* SEARCH POPUP VE MEKTUP CSS - D√úZELTƒ∞LMƒ∞≈û HALƒ∞ */
        .search-popup { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #323641; display: none; justify-content: center; align-items: center; z-index: 200; flex-direction: column; }
        
        .letter-image {
            position: relative;
            width: 200px;
            height: 200px;
            cursor: pointer;
            z-index: 205;
        }

        .animated-mail {
            position: absolute;
            height: 150px;
            width: 200px;
            transition: .4s;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .animated-mail .body {
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 100px 200px;
            border-color: transparent transparent #e95f55 transparent;
            z-index: 2;
        }

        .animated-mail .top-fold {
            position: absolute;
            top: 50px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 50px 100px 0 100px;
            transform-origin: 50% 0%;
            transition: transform .4s .4s, z-index .2s .4s;
            border-color: #cf4a43 transparent transparent transparent;
            z-index: 2;
        }

        .animated-mail .back-fold {
            position: absolute;
            bottom: 0;
            width: 200px;
            height: 100px;
            background: #cf4a43;
            z-index: 0;
        }

        .animated-mail .left-fold {
            position: absolute;
            bottom: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 50px 0 50px 100px;
            border-color: transparent transparent transparent #e95f55;
            z-index: 2;
        }

        .animated-mail .letter {
            left: 20px;
            bottom: 0px;
            position: absolute;
            width: 160px;
            height: 60px;
            background: white;
            z-index: 1;
            overflow: hidden;
            transition: .4s .2s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .animated-mail .letter .letter-border {
            height: 10px;
            width: 100%;
            background: repeating-linear-gradient(-45deg, #cb5a5e, #cb5a5e 8px, transparent 8px, transparent 18px);
            position: absolute;
            top: 0;
        }

        .animated-mail .letter .letter-title {
            margin-top: 10px;
            margin-left: 5px;
            height: 10px;
            width: 40%;
            background: #cb5a5e;
            display: none; /* Metin olduƒüu i√ßin ≈üeritleri gizledim */
        }
        
        .animated-mail .letter .letter-context {
            color: #333;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 900;
            font-size: 16px;
            line-height: 1.4;
            margin-top: 10px;
        }

        .animated-mail .letter .letter-stamp {
            margin-top: 30px;
            margin-left: 120px;
            border-radius: 100%;
            height: 30px;
            width: 30px;
            background: #cb5a5e;
            opacity: 0.3;
            position: absolute;
            right: 5px;
            bottom: 5px;
        }

        .shadow {
            position: absolute;
            top: 200px;
            left: 50%;
            width: 400px;
            height: 30px;
            transition: .4s;
            transform: translateX(-50%);
            border-radius: 100%;
            background: radial-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.0), rgba(0,0,0,0.0));
            z-index: 204;
        }

        /* Hover ve Click Animasyonlarƒ± */
        .letter-image:hover .animated-mail, 
        .letter-image.open .animated-mail {
            transform: translate(-50%, -50px);
        }

        .letter-image:hover .animated-mail .top-fold, 
        .letter-image.open .animated-mail .top-fold {
            transition: transform .4s, z-index .2s;
            transform: rotateX(180deg);
            z-index: 0;
        }

        .letter-image:hover .animated-mail .letter, 
        .letter-image.open .animated-mail .letter {
            height: 180px;
            z-index: 2; /* Mektup a√ßƒ±lƒ±nca √∂ne gelsin */
        }

        .letter-image:hover .shadow, 
        .letter-image.open .shadow {
            width: 250px;
        }

        .close-btn-container {
            margin-top: 80px;
            z-index: 210;
        }

        .close-btn-container button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 10px 24px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        .instruction-text {
            color: rgba(255,255,255,0.5);
            margin-top: 20px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        /* ------------------------------------ */

        .double-heart { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.2); font-size: 120px; pointer-events: none; opacity: 0; transition: transform 450ms cubic-bezier(.2,.8,.2,1), opacity 450ms; text-shadow: 0 6px 18px rgba(0,0,0,0.6); z-index: 800; }
        .double-heart.show { transform: translate(-50%, -50%) scale(1); opacity: 1; animation: heartPop 700ms forwards; color: #ff2d55; }
        @keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0.2); opacity: 0; } 30% { transform: translate(-50%, -50%) scale(1.15); opacity: 1; } 60% { transform: translate(-50%, -50%) scale(0.95); } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
        
        .sound-tutorial-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .tutorial-content { background: #1c1c1c; padding: 25px 35px; border-radius: 12px; text-align: center; max-width: 80%; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
        .tutorial-content p { font-size: 16px; font-weight: 600; margin-bottom: 20px; }
        .tutorial-content button { background: #0095f6; border: none; padding: 10px 20px; border-radius: 8px; color: #fff; font-weight: 700; cursor: pointer; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
        #soundToggle { animation: none; border-radius: 50%; }
        .sound-tutorial-overlay.visible #soundToggle { animation: pulse 1s infinite; }
        @keyframes saveBounce { 0% { transform: scale(1); } 50% { transform: scale(1.35); } 100% { transform: scale(1); } }
        .action-btn.saved { animation: saveBounce 0.4s; filter: brightness(0) saturate(100%) invert(100%); text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
        
        #reels-view { display: none; width: 100%; height: 100vh; height: 100dvh; background: #000; overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; position: absolute; top: 0; left: 0; z-index: 60; }
        #reels-view::-webkit-scrollbar { display: none; }
        .reel-container { width: 100%; height: 100vh; height: 100dvh; position: relative; scroll-snap-align: start; scroll-snap-stop: always; display: flex; align-items: center; justify-content: center; background: #000; overflow: hidden; padding-bottom: 55px; box-sizing: border-box; }
        .reel-bg { width: 100%; height: 100%; object-fit: contain; opacity: 1; background: #000; }
        .reel-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0) 40%); pointer-events: none; }
        .reel-actions { position: absolute; bottom: calc(55px + env(safe-area-inset-bottom)); right: 10px; display: flex; flex-direction: column; align-items: center; gap: 20px; pointer-events: auto; z-index: 70; }
        .reel-btn { background: none; border: none; color: #fff; display: flex; flex-direction: column; align-items: center; cursor: pointer; font-size: 28px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .reel-btn span { font-size: 12px; margin-top: 4px; font-weight: 500; }
        .reel-info { position: absolute; bottom: calc(55px + env(safe-area-inset-bottom)); left: 15px; width: 75%; pointer-events: auto; text-align: left; z-index: 70; }
        .reel-user { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .reel-avatar { width: 36px; height: 36px; border-radius: 50%; background-size: cover; border: 2px solid #fff; }
        .reel-username { font-weight: 600; font-size: 15px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .reel-follow { border: 1px solid rgba(255,255,255,0.6); background: none; color: #fff; font-size: 12px; padding: 4px 10px; border-radius: 4px; font-weight: 600; margin-left: 5px; }
        .reel-description { font-size: 14px; line-height: 1.3; margin-bottom: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); max-height: 60px; overflow: hidden; }
        .music-ticker { display: flex; align-items: center; gap: 8px; font-size: 13px; background: rgba(0,0,0,0.4); padding: 4px 12px; border-radius: 20px; width: fit-content; }

        .reel-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            z-index: 55;
            display: none; 
            pointer-events: none;
        }

        .volume-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 15px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 65;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
        }
        
        .volume-icon.show {
            opacity: 1;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* YENƒ∞ EKLENEN REELS REFRESH LOADER CSS */
        #reels-refresh-loader {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #0095f6; /* Instagram mavisi */
            border-radius: 50%;
            z-index: 200;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        #reels-refresh-loader.visible {
            opacity: 1;
            transform: translateX(-50%) scale(1.2);
        }

        #reels-refresh-loader.spinning {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-content">
            <p>Y√úKLENƒ∞YOR</p>
            <div id="loading-tip"></div>
            <div class="loader-dots"><div></div><div></div><div></div></div>
        </div>
    </div>

    <div id="offline-banner">ƒ∞nternet Baƒülantƒ±sƒ± Yok ‚ö†Ô∏è</div>
    <div id="reels-refresh-loader"></div>
    
    <div id="main-content">
        <div class="container">
            <div class="sound-tutorial-overlay" id="soundTutorialOverlay">
                <div class="tutorial-content">
                    <p>üîä Buradan sesi a√ßƒ±p kapatabilirsiniz!</p>
                    <button onclick="closeSoundTutorial()">Anladƒ±m</button>
                </div>
            </div>

            <div class="header" id="mainHeader">
                <div class="time" id="time">16:39</div>
                <div class="producer">Yapƒ±mcƒ±: Sude Naz T√ºrkeli</div>
                <button id="soundToggle" class="sound-btn">üîá</button>
            </div>

            <div class="posts-container" id="postsContainer"></div>

            <div id="reels-view"></div>

            <div class="bottom-nav">
                <button class="nav-btn active" data-action="home">üè†</button>
                <button class="nav-btn" data-action="search">üîç</button>
                <button class="nav-btn" data-action="add">‚ûï</button>
                <button class="nav-btn" data-action="reels">‚ñ∂Ô∏è</button>
                <button class="nav-btn" data-action="profile">üë§</button>
            </div>

            <div class="search-popup" id="searchPopup">
                <div class="letter-image" onclick="toggleLetter(this)">
                    <div class="animated-mail">
                        <div class="back-fold"></div>
                        <div class="letter">
                            <div class="letter-border"></div>
                            <div class="letter-title"></div>
                            <div class="letter-context">SUDE NAZ<br>T√úRKELƒ∞</div>
                            <div class="letter-stamp">
                                <div class="letter-stamp-inner"></div>
                            </div>
                        </div>
                        <div class="top-fold"></div>
                        <div class="body"></div>
                        <div class="left-fold"></div>
                    </div>
                    <div class="shadow"></div>
                </div>
                <div class="instruction-text">Mektubu A√ßmak ƒ∞√ßin Dokun</div>
                <div class="close-btn-container">
                    <button onclick="closeSearch()">Kapat</button>
                </div>
            </div>
        </div> 
    </div>
    <script>
        const posts = [
            {avatar:'sude_naz.jpg',user:'sude_naz',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post1.png',audio:'post1music.mp3',likes:1234,caption:'Sadece stomalƒ± bireyler deƒüil herkesin saƒülƒ±klƒ± beslenmeye dikkat etmesi, √∂ƒü√ºnlerini planlamasƒ± ve saƒülƒ±ksƒ±z besinlerden ka√ßƒ±nmasƒ± gerekmektedir.',comments:45,comment:'burcin_hoca m√ºkemmel olmu≈ü üëè',time:'2 saat √∂nce'},
            {avatar:'zeynep.jpg',user:'zeynep',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post2.jpg',audio:'post2music.mp3',likes:1134,caption:'Her ki≈üinin yiyeceklere kar≈üƒ± verdiƒüi tepkiler ve toleransƒ± farklƒ±dƒ±r. Diyet insandan insana fizyolojik ihtiya√ßlar-gereksinimler-kar≈üƒ±lama g√ºc√º ve isteklere g√∂re deƒüi≈üiklik g√∂stermektedir. Gƒ±dalar da ila√ßlar gibidir. Size iyi gelen bana iyi gelmeyebilir!',comments:77,time:'4 saat √∂nce'},
            {avatar:'irem_sude.jpg',user:'irem_sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post3.jpg',audio:'post3music.mp3',likes:3789,caption:'Lifli gƒ±dalarƒ±n az t√ºketilmesi ishale, √ßok t√ºketilmesi tƒ±kaca sebep olabilir. Stomalƒ± bireyler √∂ƒü√ºnlerini kendi beslenme alƒ±≈ükanlƒ±klarƒ±nƒ± ke≈üfederek hazƒ±rlamalƒ± ve bir profesyonel e≈üliƒüinde diyetini s√ºrd√ºrmelidir.',comments:89,time:'45 dakika √∂nce'},
            {avatar:'nisanur.jpg',user:'nisanur',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post4.jpg',audio:'post4music.mp3',likes:4123,caption:'Stomalƒ± bireylerde iyi √ßiƒüneme, gƒ±danƒ±n sindirime uygun kƒ±vama getirilmesini saƒülayarak stoma √ßƒ±kƒ±≈üƒ±nda tƒ±kanma riskini azaltƒ±r. Yetersiz √ßiƒünenmi≈ü besinler √∂zellikle lifli ve sert yapƒ±lƒ± gƒ±dalarda l√ºmeni mekanik olarak tƒ±kayƒ±p karƒ±n aƒürƒ±sƒ±, bulantƒ± ve distansiyona yol a√ßabilir.',comments:92,time:'30 dakika √∂nce'},
            {avatar:'sude.jpg',user:'sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post5.jpg',audio:'post5music.mp3',likes:5567,caption:'Stomalƒ± bireyler hangi besinin a≈üƒ±rƒ± gaz, kabƒ±zlƒ±k, ishal ya da koku gibi yan etkilere neden olduƒüunu √∂ƒürenmeli. Besinler rahatsƒ±zlƒ±k veriyorlarsa 1 hafta t√ºketilmemeli ve sonra tekrar denenmeli.',comments:134,time:'15 dakika √∂nce'},
            {avatar:'sude_naz.jpg',user:'sude_naz',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post6.jpg',audio:'post6music.mp3',likes:6234,caption:'Gaz yapan besinlerin t√ºketiminden sakƒ±nmaya ek olarak: 1- Yemek yerken konu≈ümama, aƒüƒ±z a√ßƒ±k yemek yememe, 2- √∂ƒü√ºnleri yava≈ü ve k√º√ß√ºk lokmalar halinde t√ºketme, 3- Az ve sƒ±k beslenme, uygulamalarƒ± yapƒ±labilir. Saƒülƒ±klƒ± g√ºnler dileriz!',comments:156,comment:'burcin_hoca Aferin Zeynep üëè',time:'10 dakika √∂nce'},
            {avatar:'zeynep.jpg',user:'zeynep',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post7.jpg',audio:'post7music.mp3',likes:7891,caption:'Egzersiz (y√ºr√ºy√º≈ü vb.) tƒ±ka√ß olu≈üumuna iyi gelir. B√∂ylelikle rahatsƒ±zlƒ±k hissetmezsiniz. Stomanƒ±za uygun bir bakƒ±m yaparsanƒ±z egzersizi g√∂n√ºl rahatlƒ±ƒüƒ±yla yapabilirsiniz.',comments:178,time:'5 dakika √∂nce'},
            {avatar:'irem_sude.jpg',user:'irem_sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post8.jpg',audio:'post8music.mp3',likes:8345,caption:'Yiyecek toleransƒ± ki≈üiden ki≈üiye deƒüi≈üebilmektedir. ƒ∞nsanlar aynƒ± besinlere, aynƒ± tepkileri vermez: Hangi besinlerden ka√ßƒ±nmak gerektiƒüini stomalƒ± bireyler kendi deneyimleriyle √∂ƒürenir. bir √ßalƒ±≈ümada stomalƒ± bir bireyin yoƒüurt i√ßin dedikleri dikkat √ßekmektedir: "Yoƒüurt yiyin diyorlar ama beni rahatsƒ±z ediyor, yiyemiyorum. Herkeste aynƒ± deƒüil ki..."',comments:201,comment:'burcin_hoca √ßok iyi yapmƒ±≈üsƒ±n üëè',time:'3 dakika √∂nce'},
            {avatar:'nisanur.jpg',user:'nisanur',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post9.jpg',audio:'post9music.mp3',likes:9456,caption:'Saƒülƒ±klƒ± bir baƒüƒ±rsaktan g√ºnde 100 ml, intestinal stomalƒ± bireylerde normalden 1-2L fazla sƒ±vƒ± kaybƒ± olabilmektedir. Kƒ±saca, baƒüƒ±rsaklardan normalden daha fazla sƒ±vƒ± kaybedilir. Bu y√ºzden bol miktarda sƒ±vƒ± almak √∂nemlidir.',comments:223,comment:'burcin_hoca m√ºkemmel olmu≈ü üëè',time:'2 dakika √∂nce'},
            {avatar:'sude.jpg',user:'sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post10.jpg',audio:'post10music.mp3',likes:10567,caption:'Kilo alƒ±mƒ± genellikle uygunsuz bir diyetin sonucu ger√ßekle≈üir. Stomalƒ± bireyler Stoma saƒülƒ±ƒüƒ± i√ßin kilolarƒ±na dikkat etmek durumundadƒ±r. Kilo alƒ±mƒ± stomada bazƒ± komplikasyonlara yol a√ßabilir.',comments:245,time:'1 dakika √∂nce'},
            {avatar:'sude_naz.jpg',user:'sude_naz',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post11.jpg',audio:'post11music.mp3',likes:11234,caption:'Hayƒ±rlƒ± Cumalar ü•ÄüïäÔ∏è',comments:267,time:'≈ûimdi'},
            {avatar:'zeynep.jpg',user:'zeynep',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post12.jpg',audio:'post12music.mp3',likes:12456,caption:'Yaƒülƒ± besinler gerek i√ßerdiƒüi y√ºksek yaƒü ve trans yaƒü oranlarƒ±yla gerekse kilo yapƒ±mƒ±, kolesterol gibi etkilere neden olmalarƒ± dolayƒ±sƒ±yla uzak durulmasƒ± gereken besinler arasƒ±ndadƒ±r.',comments:289,time:'≈ûimdi'}
        ];
        
        const reels = [
            {video:'reels1.mp4',avatar:'sude_naz.jpg',user:'sude_naz',likes:'15K',comments:'234',desc:'Kameramƒ±za kar≈üƒ± itiraflar alƒ±yoruz. #stoma #√ºnl√º'},
            {video:'reels2.mp4',avatar:'zeynep.jpg',user:'zeynep',likes:'33K',comments:'1K',desc:'Her ki≈üinin √∂ƒürenme ≈üekli farklƒ±dƒ±r. #stomagram #farkƒ±ndalƒ±k'},
            {video:'reels3.mp4',avatar:'manav.jpg',user:'manav_abdulkadir',likes:'12K',comments:'550',desc:'Meyve dediƒüin b√∂yle olacak! #saƒülƒ±k #beslenme'},
            {video:'reels4.mp4',avatar:'nisanur.jpg',user:'nisanur',likes:'5K',comments:'120',desc:'Su i√ßmeyi sakƒ±n unutmayƒ±n! #tavsiye'},
            {video:'reels5.mp4',avatar:'sude.jpg',user:'sude',likes:'89K',comments:'2K',desc:'Boƒüa bur√ßlarƒ± dikkat ‚ö†Ô∏è‚òùÔ∏è #g√ºnl√ºk #burcyorumlari'},
            {video:'reels6.mp4',avatar:'sude_naz.jpg',user:'sude_naz',likes:'42K',comments:'900',desc:'Egzersiz yapmak sindirimi kolayla≈ütƒ±rƒ±r.'},
            {video:'reels7.mp4',avatar:'zeynep.jpg',user:'zeynep',likes:'11K',comments:'340',desc:'ü§® #wolf'},
            {video:'reels8.mp4',avatar:'irem_sude.jpg',user:'irem_sude',likes:'26K',comments:'800',desc:'Besinleri iyi √ßiƒünemek sindirimi kolayla≈ütƒ±rƒ±r.'},
            {video:'reels9.mp4',avatar:'nisanur.jpg',user:'nisanur',likes:'67K',comments:'1.5K',desc:'ü´°ü´° #ata'},
            {video:'reels10.mp4',avatar:'sude_naz.jpg',user:'sude_naz',likes:'15K',comments:'234',desc:'üòÇüòÇ #stoma #komik'},
            {video:'reels11.mp4',avatar:'zeynep.jpg',user:'zeynep',likes:'33K',comments:'1K',desc:'Saƒülƒ±ƒüƒ±nƒ±z i√ßin kilo alƒ±mƒ±nƒ±za dikkat edin! #zayƒ±flama #celalkedi'},
            {video:'reels12.mp4',avatar:'irem_sude.jpg',user:'irem_sude',likes:'12K',comments:'550',desc:'≈ûeker ve fazla yaƒüdan saƒülƒ±ƒüƒ±nƒ±z i√ßin uzak durun! #saƒülƒ±k #beslenme'}
        ];

        const container = document.getElementById('postsContainer');
        const reelsView = document.getElementById('reels-view');
        
        posts.sort(() => Math.random() - 0.5).forEach(p => {
            const el = document.createElement('div');
            el.className = 'post';
            el.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar" style="background-image:url('${p.avatar}')"></div>
                    <div class="post-info">
                        <div class="post-username">${p.user} <span class="verified">‚úì</span> <button class="follow-btn" onclick="toggleFollow(this)">Takip Et</button></div>
                        <div class="post-subtitle">${p.subtitle}</div>
                    </div>
                    <div class="post-menu">‚ãÆ</div>
                </div>
                <div class="post-content">
                    <img src="${p.img}" class="post-image">
                    <audio class="post-audio" loop muted><source src="${p.audio}" type="audio/mp3"></audio>
                </div>
                <div class="post-actions">
                    <div class="action-group">
                        <button class="action-btn" onclick="likePost(this)">ü§ç</button>
                        <button class="action-btn">üí¨</button>
                        <button class="action-btn">üì§</button>
                    </div>
                    <button class="action-btn" onclick="toggleSave(this)">üîñ</button>
                </div>
                <div class="post-likes"><span class="likes-count">${p.likes.toLocaleString()}</span> beƒüenme</div>
                <div class="post-caption" data-full-text="${p.caption}">
                    <span class="username-caption">${p.user}</span>
                    <span class="caption-text">${p.caption}</span>
                </div>
                <div class="post-comments">${p.comments} yorumun t√ºm√ºn√º g√∂r</div>
                ${p.comment ? `<div class="post-comments">${p.comment}</div>` : ''}
                <div class="post-time">${p.time}</div>
            `;
            container.appendChild(el);
        });

        // REELS OLU≈ûTURMA FONKSƒ∞YONU VE PULL-TO-REFRESH MANTIƒûI
        let currentReelList = [];

        // Observer tanƒ±mlarƒ± (Daha √∂nce global tanƒ±mlanmalƒ± ki fonksiyon i√ßinde kullanƒ±labilsin)
        const reelsObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target.querySelector('.reel-video');
                if (!video) return;
                if (entry.isIntersecting) {
                    video.preload = "auto";
                    video.currentTime = 0;
                    video.muted = false; 
                    video.play().catch(e => console.log("Reel autoplay engellendi"));
                    const nextReel = entry.target.nextElementSibling;
                    if (nextReel) {
                        const nextVideo = nextReel.querySelector('.reel-video');
                        if (nextVideo) nextVideo.preload = "auto";
                    }
                } else {
                    video.pause();
                    video.currentTime = 0;
                    video.preload = "none";
                }
            });
        }, { threshold: 0.6 });

        // Reels verilerini ekrana basan fonksiyon
        function renderReelsData() {
            reelsView.innerHTML = ''; // Mevcut i√ßeriƒüi temizle
            
            // Listeyi karƒ±≈ütƒ±r
            reels.sort(() => Math.random() - 0.5).forEach(r => {
                const el = document.createElement('div');
                el.className = 'reel-container';
                el.innerHTML = `
                    <video class="reel-video reel-bg" src="${r.video}" loop playsinline preload="none"></video>
                    <div class="reel-overlay"></div>
                    <div class="reel-loader"></div>
                    <div class="volume-icon">üîá</div>
                    <div class="reel-actions">
                        <button class="reel-btn" onclick="likeReel(this)">ü§ç <span>${r.likes}</span></button>
                        <button class="reel-btn">üí¨ <span>${r.comments}</span></button>
                        <button class="reel-btn">üì§ <span>Payla≈ü</span></button>
                        <button class="reel-btn">‚ãØ</button>
                    </div>
                    <div class="reel-info">
                        <div class="reel-user">
                            <div class="reel-avatar" style="background-image:url('${r.avatar}')"></div>
                            <span class="reel-username">${r.user}</span>
                            <button class="reel-follow">Takip Et</button>
                        </div>
                        <div class="reel-description">${r.desc}</div>
                        <div class="music-ticker">üéµ Orijinal Ses - ${r.user}</div>
                    </div>
                `;
                
                // Eventleri ve G√∂zlemciyi yeniden baƒüla
                setupReelEvents(el);
                attachDoubleTap(el);
                reelsObserver.observe(el);
                reelsView.appendChild(el);
            });

            // Sonsuz d√∂ng√º listesini g√ºncelle
            currentReelList = Array.from(document.querySelectorAll('.reel-container'));
        }

        // Ba≈ülangƒ±√ßta Reels'leri y√ºkle
        renderReelsData();

        // Reels Eventlerini Ayarlayan Fonksiyon
        function setupReelEvents(container) {
            const video = container.querySelector('.reel-video');
            const loader = container.querySelector('.reel-loader');
            const volumeIcon = container.querySelector('.volume-icon');

            // 1. Loading Durumu (Buffering)
            video.addEventListener('waiting', () => {
                loader.style.display = 'block';
            });
            video.addEventListener('playing', () => {
                loader.style.display = 'none';
            });

            // 2. Tƒ±klayƒ±nca Ses A√ß/Kapat (Toggle Mute)
            container.addEventListener('click', (e) => {
                // Eƒüer butonlara tƒ±klanƒ±rsa √ßalƒ±≈ümasƒ±n
                if (e.target.closest('.reel-btn') || e.target.closest('.reel-follow')) return;

                // Ses durumunu deƒüi≈ütir
                video.muted = !video.muted;
                
                // ƒ∞konu g√∂ster
                volumeIcon.textContent = video.muted ? "üîá" : "üîä";
                volumeIcon.classList.add('show');
                
                // 1 saniye sonra ikonu gizle
                setTimeout(() => {
                    volumeIcon.classList.remove('show');
                }, 1000);
            });
        }

        let soundEnabled = false, currentPostList = [];
        
        const tips = [
            "Sude Naz T. bu projeye 60 saatten fazla zaman harcadƒ±.",
            "Bur√ßin hoca bizce bize y√ºksek not verecek ‚ù§Ô∏è", 
            "Dengeli beslenmek i√ßin bir diyetisyenle g√∂r√º≈ü√ºn.",
            "Stomalƒ± bireyler gaz √ßƒ±kƒ±≈üƒ±nƒ± kontrol edemez.",
            "Stoma varlƒ±ƒüƒ± bir hastalƒ±k deƒüildir.",
            "Stoma bakƒ±mƒ±nƒ± aksatmayƒ±nƒ±z.",
            "Dengeli beslenmek saƒülƒ±ƒüƒ±n temelidir.",
            "Her g√ºn 1-2L su i√ßmek saƒülƒ±ƒüa yararlƒ±dƒ±r.",
            "Stomanƒ±zla barƒ±≈üƒ±k olun. (opsiyonel)",
            "Y√ºkleme ekranƒ±nda 10 farklƒ± bilgi vardƒ±r."
        ];
        
        let tipIndex = 0, tipInterval;
        
        function displayTip() {
            const el = document.getElementById('loading-tip');
            el.style.opacity = 0;
            setTimeout(() => {
                el.innerHTML = `<strong>Bunu Biliyor Muydunuz:</strong> ${tips[tipIndex]}`;
                el.style.opacity = 1;
                tipIndex = (tipIndex + 1) % tips.length;
            }, 500);
        }

        const initialEl = document.getElementById('loading-tip');
        initialEl.innerHTML = `<strong>Bunu Biliyor Muydunuz:</strong> ${tips[0]}`;
        initialEl.style.opacity = 1;
        tipIndex = 1;

        tipInterval = setInterval(displayTip, 2500);

        window.addEventListener('load', () => {
            const preloader = document.getElementById('preloader');
            const mainContent = document.getElementById('main-content');
            const videosToPreloadCount = 2;
            const allReels = document.querySelectorAll('.reel-video');
            let loadedCount = 0, appStarted = false;

            function startApp() {
                if (appStarted) return;
                appStarted = true;
                if (tipInterval) clearInterval(tipInterval);
                mainContent.style.display = 'flex';
                preloader.classList.add('hidden');
                setTimeout(() => preloader.style.display = 'none', 500);
            }

            function checkVideoLoaded() {
                loadedCount++;
                if (loadedCount >= videosToPreloadCount) startApp();
            }

            if (allReels.length === 0) {
                startApp();
            } else {
                const limit = Math.min(allReels.length, videosToPreloadCount);
                for (let i = 0; i < limit; i++) {
                    const video = allReels[i];
                    video.preload = "auto";
                    video.onloadeddata = checkVideoLoaded;
                    if (video.readyState >= 3) checkVideoLoaded();
                }
            }
            setTimeout(() => { if (!appStarted) startApp(); }, 5000);
        });

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        function updateOnlineStatus() {
            document.getElementById('offline-banner').style.display = !navigator.onLine ? 'block' : 'none';
        }
        updateOnlineStatus();

        function updateTime() {
            const el = document.getElementById("time");
            const now = new Date();
            let h = now.getHours(), m = now.getMinutes();
            if (h < 10) h = "0" + h;
            if (m < 10) m = "0" + m;
            el.textContent = h + ":" + m;
        }
        updateTime();
        setInterval(updateTime, 1000);

        function toggleFollow(btn) {
            btn.classList.toggle('following');
            btn.textContent = btn.classList.contains('following') ? 'Takip Ediliyor' : 'Takip Et';
            btn.style.color = btn.classList.contains('following') ? '#a8a8a8' : '#0095f6';
            event.stopPropagation();
        }

        function likePost(btn) {
            btn.classList.toggle("liked");
            const likesSpan = btn.closest('.post').querySelector('.likes-count');
            let count = parseInt(likesSpan.textContent.replace(/,/g, ''));
            if (btn.classList.contains("liked")) {
                btn.textContent = "‚ù§Ô∏è";
                count += 1;
            } else {
                btn.textContent = "ü§ç";
                count -= 1;
            }
            likesSpan.textContent = count.toLocaleString();
        }

        function toggleSave(btn) {
            const isSaved = btn.classList.toggle('saved');
            btn.textContent = isSaved ? 'üè∑Ô∏è' : 'üîñ';
        }

        function likeReel(btn) {
            btn.classList.toggle("liked");
            let textSpan = btn.querySelector('span');
            let text = textSpan.textContent;
            if (btn.classList.contains("liked")) {
                btn.innerHTML = `‚ù§Ô∏è <span>${text}</span>`;
                btn.style.color = '#ed4956';
            } else {
                btn.innerHTML = `ü§ç <span>${text}</span>`;
                btn.style.color = '#fff';
            }
        }

        function showHeart(el) {
            let heart = document.createElement('div');
            heart.className = 'double-heart';
            heart.innerHTML = '‚ù§Ô∏è';
            el.appendChild(heart);
            void heart.offsetWidth;
            heart.classList.add('show');
            setTimeout(() => {
                heart.classList.remove('show');
                setTimeout(() => { if (heart.parentElement) heart.parentElement.removeChild(heart); }, 500);
            }, 800);
        }

        function attachDoubleTap(el) {
            let lastTap = 0;
            el.addEventListener('dblclick', (e) => {
                showHeart(el);
                const post = el.closest('.post');
                const reel = el.closest('.reel-container');
                if (post) {
                    const likeBtn = post.querySelector('.action-group .action-btn');
                    if (likeBtn && !likeBtn.classList.contains('liked')) likePost(likeBtn);
                }
                if (reel) {
                    const likeBtn = reel.querySelector('.reel-actions .reel-btn:first-child');
                    if (likeBtn && !likeBtn.classList.contains('liked')) likeReel(likeBtn);
                }
            });
            el.addEventListener('touchend', function(e) {
                const currentTime = Date.now();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    showHeart(el);
                    const post = el.closest('.post');
                    const reel = el.closest('.reel-container');
                    if (post) {
                        const likeBtn = post.querySelector('.action-group .action-btn');
                        if (likeBtn && !likeBtn.classList.contains('liked')) likePost(likeBtn);
                    }
                    if (reel) {
                        const likeBtn = reel.querySelector('.reel-actions .reel-btn:first-child');
                        if (likeBtn && !likeBtn.classList.contains('liked')) likeReel(likeBtn);
                    }
                }
                lastTap = currentTime;
            });
        }
        document.querySelectorAll('.post-content').forEach(el => attachDoubleTap(el));
        
        // Reels i√ßin attachDoubleTap fonksiyonu zaten renderReelsData i√ßinde √ßaƒürƒ±lƒ±yor.

        const soundToggle = document.getElementById("soundToggle");
        const postsContainer = document.getElementById("postsContainer");

        function managePostAudio(post, shouldPlay) {
            if (document.getElementById('reels-view').style.display === 'block') return;
            const audio = post.querySelector(".post-audio");
            if (!audio) return;
            if (shouldPlay) {
                audio.muted = !soundEnabled;
                audio.volume = 0.6;
                audio.play().catch(e => console.log("Oynatma engellendi"));
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        const feedObserver = new IntersectionObserver(entries => {
            entries.forEach(entry => managePostAudio(entry.target, entry.isIntersecting));
        }, { threshold: 0.6 });
        document.querySelectorAll('.post').forEach(post => feedObserver.observe(post));

        soundToggle.addEventListener("click", () => {
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? "üîä" : "üîá";
            document.querySelectorAll(".post").forEach(post => {
                const rect = post.getBoundingClientRect();
                if (rect.bottom > 0 && rect.top < window.innerHeight) managePostAudio(post, true);
            });
        });

        const navButtons = document.querySelectorAll(".nav-btn");
        const searchPopup = document.getElementById("searchPopup");
        const reelsViewEl = document.getElementById("reels-view");
        const mainHeader = document.getElementById("mainHeader");

        navButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const action = btn.getAttribute("data-action");
                if (action === "search") {
                    searchPopup.style.display = "flex";
                    // Reset letter state
                    const letter = document.querySelector('.letter-image');
                    letter.classList.remove('open');
                    return;
                }
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll(".post-audio").forEach(a => { a.pause(); a.currentTime = 0; });
                document.querySelectorAll(".reel-video").forEach(v => { v.pause(); v.currentTime = 0; });
                if (action === "home") {
                    postsContainer.style.display = "block";
                    reelsViewEl.style.display = "none";
                    mainHeader.style.display = "flex";
                    postsContainer.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (action === "reels") {
                    postsContainer.style.display = "block";
                    reelsViewEl.style.display = "block";
                    mainHeader.style.display = "none";
                    reelsViewEl.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    navButtons.forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-action="home"]').classList.add('active');
                }
            });
        });

        function closeSearch() { 
            searchPopup.style.display = "none"; 
        }

        function toggleLetter(element) {
            element.classList.toggle('open');
        }

        function closeSoundTutorial() {
            document.getElementById("soundTutorialOverlay").style.display = "none";
            soundToggle.style.animation = "none";
            document.body.style.overflow = '';
            localStorage.setItem('soundTutorialShown', 'true');
        }

        window.addEventListener('load', () => {
            if (localStorage.getItem('soundTutorialShown') !== 'true') {
                setTimeout(() => {
                    soundToggle.textContent = "üîá";
                    soundToggle.style.animation = "pulse 1.5s infinite";
                    document.getElementById("soundTutorialOverlay").style.display = "flex";
                    document.body.style.overflow = 'hidden';
                }, 500);
            }
        });

        const MAX_LENGTH = 55;
        function initializeCaptionTruncation() {
            document.querySelectorAll('.post-caption').forEach(captionDiv => {
                const textNode = captionDiv.querySelector('.caption-text');
                if (!textNode) return;
                const rawText = textNode.textContent.trim();
                captionDiv.setAttribute('data-full-text', rawText);
                if (rawText.length <= MAX_LENGTH) return;
                const truncatedText = rawText.substring(0, MAX_LENGTH) + '...';
                textNode.textContent = truncatedText;
                const readMoreBtn = document.createElement('span');
                readMoreBtn.className = 'read-more-btn';
                readMoreBtn.textContent = 'devamƒ±nƒ± oku';
                readMoreBtn.onclick = function(e) {
                    const isExpanded = captionDiv.classList.toggle('expanded');
                    if (isExpanded) {
                        textNode.textContent = rawText;
                        readMoreBtn.textContent = 'gizle';
                    } else {
                        textNode.textContent = truncatedText;
                        readMoreBtn.textContent = 'devamƒ±nƒ± oku';
                    }
                    e.stopPropagation();
                };
                captionDiv.appendChild(readMoreBtn);
            });
        }
        window.addEventListener('load', initializeCaptionTruncation);

        setTimeout(() => { currentPostList = Array.from(document.querySelectorAll('.post')); }, 300);
        
        // currentReelList, renderReelsData i√ßinde atanƒ±yor.

        postsContainer.addEventListener('scroll', () => {
            if (postsContainer.scrollTop + postsContainer.clientHeight >= postsContainer.scrollHeight - 800) {
                currentPostList.forEach(originalPost => {
                    const clone = originalPost.cloneNode(true);
                    feedObserver.observe(clone);
                    attachDoubleTap(clone.querySelector('.post-content'));
                    const saveBtn = clone.querySelector('.action-btn:last-child');
                    if (saveBtn) {
                        saveBtn.classList.remove('saved');
                        saveBtn.textContent = 'üîñ';
                    }
                    container.appendChild(clone);
                });
            }
        });

        reelsViewEl.addEventListener('scroll', () => {
            if (reelsViewEl.scrollTop + reelsViewEl.clientHeight >= reelsViewEl.scrollHeight - 400) {
                currentReelList.forEach(originalReel => {
                    const clone = originalReel.cloneNode(true);
                    const video = clone.querySelector('.reel-video');
                    if (video) {
                        video.pause();
                        video.currentTime = 0;
                        video.muted = true;
                        video.preload = "none";
                    }
                    reelsObserver.observe(clone);
                    setupReelEvents(clone); 
                    attachDoubleTap(clone);
                    reelsView.appendChild(clone);
                });
            }
        });

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                document.querySelectorAll(".post-audio").forEach(a => { a.pause(); a.currentTime = 0; });
                document.querySelectorAll(".reel-video").forEach(v => { v.pause(); v.currentTime = 0; });
            } else {
                if (reelsViewEl.style.display !== 'block' && soundEnabled) {
                    document.querySelectorAll('.post').forEach(post => {
                        const rect = post.getBoundingClientRect();
                        if (rect.bottom > 0 && rect.top < window.innerHeight) managePostAudio(post, true);
                    });
                }
            }
        });

        let startY = 0, isPulling = false;
        postsContainer.addEventListener("touchstart", (e) => {
            if (postsContainer.scrollTop === 0) {
                startY = e.touches[0].clientY;
                isPulling = true;
            }
        });
        postsContainer.addEventListener("touchmove", (e) => {
            if (!isPulling) return;
            let currentY = e.touches[0].clientY;
            if ((currentY - startY) > 80) { location.reload(); isPulling = false; }
        });
        postsContainer.addEventListener("touchend", () => { isPulling = false; });

        document.querySelectorAll(".action-btn").forEach(btn => {
            if (btn.textContent.includes("üì§")) {
                btn.addEventListener("click", async () => {
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: "Stomagram Postu",
                                text: "Buna bir g√∂z at! üëÄ",
                                url: window.location.href
                            });
                        } catch (err) { console.log("Payla≈üƒ±m iptal edildi:", err); }
                    } else { alert("Cihazƒ±nƒ±z payla≈üƒ±mƒ± desteklemiyor."); }
                });
            }
        });

        /* --- REELS PULL-TO-REFRESH MANTIƒûI --- */
        const reelsLoader = document.getElementById('reels-refresh-loader');
        let reelStartY = 0;
        let isReelPulling = false;

        reelsView.addEventListener('touchstart', (e) => {
            if (reelsView.scrollTop === 0) {
                reelStartY = e.touches[0].clientY;
                isReelPulling = true;
            }
        }, {passive: true});

        reelsView.addEventListener('touchmove', (e) => {
            if (!isReelPulling) return;
            const currentY = e.touches[0].clientY;
            const pullDistance = currentY - reelStartY;

            if (pullDistance > 0 && reelsView.scrollTop === 0) {
                if (pullDistance > 60) {
                    reelsLoader.classList.add('visible');
                    if (navigator.vibrate && pullDistance === 61) navigator.vibrate(10);
                } else {
                    reelsLoader.classList.remove('visible');
                }
            } else {
                isReelPulling = false;
            }
        }, {passive: true});

        reelsView.addEventListener('touchend', (e) => {
            if (!isReelPulling) return;
            isReelPulling = false;
            if (reelsLoader.classList.contains('visible')) {
                reelsLoader.classList.remove('visible');
                reelsLoader.classList.add('spinning'); 

                setTimeout(() => {
                    renderReelsData(); 
                    reelsLoader.classList.remove('spinning');
                    const firstVideo = document.querySelector('.reel-container:first-child .reel-video');
                    if(firstVideo) {
                        firstVideo.play().catch(()=>{});
                        firstVideo.muted = false;
                    }
                }, 1200);
            }
        });
    </script>
</body>
</html>
 4px 12px; border-radius: 20px; width: fit-content; }

        .reel-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            z-index: 55;
            display: none; 
            pointer-events: none;
        }

        .volume-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 15px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 65;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
        }
        
        .volume-icon.show {
            opacity: 1;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* YENƒ∞ EKLENEN REELS REFRESH LOADER CSS */
        #reels-refresh-loader {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #0095f6; /* Instagram mavisi */
            border-radius: 50%;
            z-index: 200;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        #reels-refresh-loader.visible {
            opacity: 1;
            transform: translateX(-50%) scale(1.2);
        }

        #reels-refresh-loader.spinning {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-content">
            <p>Y√úKLENƒ∞YOR</p>
            <div id="loading-tip"></div>
            <div class="loader-dots"><div></div><div></div><div></div></div>
        </div>
    </div>

    <div id="offline-banner">ƒ∞nternet Baƒülantƒ±sƒ± Yok ‚ö†Ô∏è</div>
    <div id="reels-refresh-loader"></div>
    
    <div id="main-content">
        <div class="container">
            <div class="sound-tutorial-overlay" id="soundTutorialOverlay">
                <div class="tutorial-content">
                    <p>üîä Buradan sesi a√ßƒ±p kapatabilirsiniz!</p>
                    <button onclick="closeSoundTutorial()">Anladƒ±m</button>
                </div>
            </div>

            <div class="header" id="mainHeader">
                <div class="time" id="time">16:39</div>
                <div class="producer">Yapƒ±mcƒ±: Sude Naz T√ºrkeli</div>
                <button id="soundToggle" class="sound-btn">üîá</button>
            </div>

            <div class="posts-container" id="postsContainer"></div>

            <div id="reels-view"></div>

            <div class="bottom-nav">
                <button class="nav-btn active" data-action="home">üè†</button>
                <button class="nav-btn" data-action="search">üîç</button>
                <button class="nav-btn" data-action="add">‚ûï</button>
                <button class="nav-btn" data-action="reels">‚ñ∂Ô∏è</button>
                <button class="nav-btn" data-action="profile">üë§</button>
            </div>

            <div class="search-popup" id="searchPopup">
                <div class="search-content">
                    <h2>YAPIMCI</h2>
                    <ul><li>Sude Naz T√ºrkeli</li></ul>
                    <button onclick="closeSearch()">Kapat</button>
                </div>
            </div>
        </div> 
    </div>
    <script>
        const posts = [
            {avatar:'sude_naz.jpg',user:'sude_naz',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post1.png',audio:'post1music.mp3',likes:1234,caption:'Sadece stomalƒ± bireyler deƒüil herkesin saƒülƒ±klƒ± beslenmeye dikkat etmesi, √∂ƒü√ºnlerini planlamasƒ± ve saƒülƒ±ksƒ±z besinlerden ka√ßƒ±nmasƒ± gerekmektedir.',comments:45,comment:'burcin_hoca m√ºkemmel olmu≈ü üëè',time:'2 saat √∂nce'},
            {avatar:'zeynep.jpg',user:'zeynep',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post2.jpg',audio:'post2music.mp3',likes:1134,caption:'Her ki≈üinin yiyeceklere kar≈üƒ± verdiƒüi tepkiler ve toleransƒ± farklƒ±dƒ±r. Diyet insandan insana fizyolojik ihtiya√ßlar-gereksinimler-kar≈üƒ±lama g√ºc√º ve isteklere g√∂re deƒüi≈üiklik g√∂stermektedir. Gƒ±dalar da ila√ßlar gibidir. Size iyi gelen bana iyi gelmeyebilir!',comments:77,time:'4 saat √∂nce'},
            {avatar:'irem_sude.jpg',user:'irem_sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post3.jpg',audio:'post3music.mp3',likes:3789,caption:'Lifli gƒ±dalarƒ±n az t√ºketilmesi ishale, √ßok t√ºketilmesi tƒ±kaca sebep olabilir. Stomalƒ± bireyler √∂ƒü√ºnlerini kendi beslenme alƒ±≈ükanlƒ±klarƒ±nƒ± ke≈üfederek hazƒ±rlamalƒ± ve bir profesyonel e≈üliƒüinde diyetini s√ºrd√ºrmelidir.',comments:89,time:'45 dakika √∂nce'},
            {avatar:'nisanur.jpg',user:'nisanur',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post4.jpg',audio:'post4music.mp3',likes:4123,caption:'Stomalƒ± bireylerde iyi √ßiƒüneme, gƒ±danƒ±n sindirime uygun kƒ±vama getirilmesini saƒülayarak stoma √ßƒ±kƒ±≈üƒ±nda tƒ±kanma riskini azaltƒ±r. Yetersiz √ßiƒünenmi≈ü besinler √∂zellikle lifli ve sert yapƒ±lƒ± gƒ±dalarda l√ºmeni mekanik olarak tƒ±kayƒ±p karƒ±n aƒürƒ±sƒ±, bulantƒ± ve distansiyona yol a√ßabilir.',comments:92,time:'30 dakika √∂nce'},
            {avatar:'sude.jpg',user:'sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post5.jpg',audio:'post5music.mp3',likes:5567,caption:'Stomalƒ± bireyler hangi besinin a≈üƒ±rƒ± gaz, kabƒ±zlƒ±k, ishal ya da koku gibi yan etkilere neden olduƒüunu √∂ƒürenmeli. Besinler rahatsƒ±zlƒ±k veriyorlarsa 1 hafta t√ºketilmemeli ve sonra tekrar denenmeli.',comments:134,time:'15 dakika √∂nce'},
            {avatar:'sude_naz.jpg',user:'sude_naz',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post6.jpg',audio:'post6music.mp3',likes:6234,caption:'Gaz yapan besinlerin t√ºketiminden sakƒ±nmaya ek olarak: 1- Yemek yerken konu≈ümama, aƒüƒ±z a√ßƒ±k yemek yememe, 2- √∂ƒü√ºnleri yava≈ü ve k√º√ß√ºk lokmalar halinde t√ºketme, 3- Az ve sƒ±k beslenme, uygulamalarƒ± yapƒ±labilir. Saƒülƒ±klƒ± g√ºnler dileriz!',comments:156,comment:'burcin_hoca Aferin Zeynep üëè',time:'10 dakika √∂nce'},
            {avatar:'zeynep.jpg',user:'zeynep',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post7.jpg',audio:'post7music.mp3',likes:7891,caption:'Egzersiz (y√ºr√ºy√º≈ü vb.) tƒ±ka√ß olu≈üumuna iyi gelir. B√∂ylelikle rahatsƒ±zlƒ±k hissetmezsiniz. Stomanƒ±za uygun bir bakƒ±m yaparsanƒ±z egzersizi g√∂n√ºl rahatlƒ±ƒüƒ±yla yapabilirsiniz.',comments:178,time:'5 dakika √∂nce'},
            {avatar:'irem_sude.jpg',user:'irem_sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post8.jpg',audio:'post8music.mp3',likes:8345,caption:'Yiyecek toleransƒ± ki≈üiden ki≈üiye deƒüi≈üebilmektedir. ƒ∞nsanlar aynƒ± besinlere, aynƒ± tepkileri vermez: Hangi besinlerden ka√ßƒ±nmak gerektiƒüini stomalƒ± bireyler kendi deneyimleriyle √∂ƒürenir. bir √ßalƒ±≈ümada stomalƒ± bir bireyin yoƒüurt i√ßin dedikleri dikkat √ßekmektedir: "Yoƒüurt yiyin diyorlar ama beni rahatsƒ±z ediyor, yiyemiyorum. Herkeste aynƒ± deƒüil ki..."',comments:201,comment:'burcin_hoca √ßok iyi yapmƒ±≈üsƒ±n üëè',time:'3 dakika √∂nce'},
            {avatar:'nisanur.jpg',user:'nisanur',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post9.jpg',audio:'post9music.mp3',likes:9456,caption:'Saƒülƒ±klƒ± bir baƒüƒ±rsaktan g√ºnde 100 ml, intestinal stomalƒ± bireylerde normalden 1-2L fazla sƒ±vƒ± kaybƒ± olabilmektedir. Kƒ±saca, baƒüƒ±rsaklardan normalden daha fazla sƒ±vƒ± kaybedilir. Bu y√ºzden bol miktarda sƒ±vƒ± almak √∂nemlidir.',comments:223,comment:'burcin_hoca m√ºkemmel olmu≈ü üëè',time:'2 dakika √∂nce'},
            {avatar:'sude.jpg',user:'sude',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post10.jpg',audio:'post10music.mp3',likes:10567,caption:'Kilo alƒ±mƒ± genellikle uygunsuz bir diyetin sonucu ger√ßekle≈üir. Stomalƒ± bireyler Stoma saƒülƒ±ƒüƒ± i√ßin kilolarƒ±na dikkat etmek durumundadƒ±r. Kilo alƒ±mƒ± stomada bazƒ± komplikasyonlara yol a√ßabilir.',comments:245,time:'1 dakika √∂nce'},
            {avatar:'sude_naz.jpg',user:'sude_naz',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post11.jpg',audio:'post11music.mp3',likes:11234,caption:'Hayƒ±rlƒ± Cumalar ü•ÄüïäÔ∏è',comments:267,time:'≈ûimdi'},
            {avatar:'zeynep.jpg',user:'zeynep',subtitle:'Eƒüitim ƒ∞√ßeriƒüi',img:'post12.jpg',audio:'post12music.mp3',likes:12456,caption:'Yaƒülƒ± besinler gerek i√ßerdiƒüi y√ºksek yaƒü ve trans yaƒü oranlarƒ±yla gerekse kilo yapƒ±mƒ±, kolesterol gibi etkilere neden olmalarƒ± dolayƒ±sƒ±yla uzak durulmasƒ± gereken besinler arasƒ±ndadƒ±r.',comments:289,time:'≈ûimdi'}
        ];
        
        const reels = [
            {video:'reels1.mp4',avatar:'sude_naz.jpg',user:'sude_naz',likes:'15K',comments:'234',desc:'Kameramƒ±za kar≈üƒ± itiraflar alƒ±yoruz. #stoma #√ºnl√º'},
            {video:'reels2.mp4',avatar:'zeynep.jpg',user:'zeynep',likes:'33K',comments:'1K',desc:'Her ki≈üinin √∂ƒürenme ≈üekli farklƒ±dƒ±r. #stomagram #farkƒ±ndalƒ±k'},
            {video:'reels3.mp4',avatar:'manav.jpg',user:'manav_abdulkadir',likes:'12K',comments:'550',desc:'Meyve dediƒüin b√∂yle olacak! #saƒülƒ±k #beslenme'},
            {video:'reels4.mp4',avatar:'nisanur.jpg',user:'nisanur',likes:'5K',comments:'120',desc:'Su i√ßmeyi sakƒ±n unutmayƒ±n! #tavsiye'},
            {video:'reels5.mp4',avatar:'sude.jpg',user:'sude',likes:'89K',comments:'2K',desc:'Boƒüa bur√ßlarƒ± dikkat ‚ö†Ô∏è‚òùÔ∏è #g√ºnl√ºk #burcyorumlari'},
            {video:'reels6.mp4',avatar:'sude_naz.jpg',user:'sude_naz',likes:'42K',comments:'900',desc:'Egzersiz yapmak sindirimi kolayla≈ütƒ±rƒ±r.'},
            {video:'reels7.mp4',avatar:'zeynep.jpg',user:'zeynep',likes:'11K',comments:'340',desc:'ü§® #wolf'},
            {video:'reels8.mp4',avatar:'irem_sude.jpg',user:'irem_sude',likes:'26K',comments:'800',desc:'Besinleri iyi √ßiƒünemek sindirimi kolayla≈ütƒ±rƒ±r.'},
            {video:'reels9.mp4',avatar:'nisanur.jpg',user:'nisanur',likes:'67K',comments:'1.5K',desc:'ü´°ü´° #ata'},
            {video:'reels10.mp4',avatar:'sude_naz.jpg',user:'sude_naz',likes:'15K',comments:'234',desc:'üòÇüòÇ #stoma #komik'},
            {video:'reels11.mp4',avatar:'zeynep.jpg',user:'zeynep',likes:'33K',comments:'1K',desc:'Saƒülƒ±ƒüƒ±nƒ±z i√ßin kilo alƒ±mƒ±nƒ±za dikkat edin! #zayƒ±flama #celalkedi'},
            {video:'reels12.mp4',avatar:'irem_sude.jpg',user:'irem_sude',likes:'12K',comments:'550',desc:'≈ûeker ve fazla yaƒüdan saƒülƒ±ƒüƒ±nƒ±z i√ßin uzak durun! #saƒülƒ±k #beslenme'}
        ];

        const container = document.getElementById('postsContainer');
        const reelsView = document.getElementById('reels-view');
        
        posts.sort(() => Math.random() - 0.5).forEach(p => {
            const el = document.createElement('div');
            el.className = 'post';
            el.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar" style="background-image:url('${p.avatar}')"></div>
                    <div class="post-info">
                        <div class="post-username">${p.user} <span class="verified">‚úì</span> <button class="follow-btn" onclick="toggleFollow(this)">Takip Et</button></div>
                        <div class="post-subtitle">${p.subtitle}</div>
                    </div>
                    <div class="post-menu">‚ãÆ</div>
                </div>
                <div class="post-content">
                    <img src="${p.img}" class="post-image">
                    <audio class="post-audio" loop muted><source src="${p.audio}" type="audio/mp3"></audio>
                </div>
                <div class="post-actions">
                    <div class="action-group">
                        <button class="action-btn" onclick="likePost(this)">ü§ç</button>
                        <button class="action-btn">üí¨</button>
                        <button class="action-btn">üì§</button>
                    </div>
                    <button class="action-btn" onclick="toggleSave(this)">üîñ</button>
                </div>
                <div class="post-likes"><span class="likes-count">${p.likes.toLocaleString()}</span> beƒüenme</div>
                <div class="post-caption" data-full-text="${p.caption}">
                    <span class="username-caption">${p.user}</span>
                    <span class="caption-text">${p.caption}</span>
                </div>
                <div class="post-comments">${p.comments} yorumun t√ºm√ºn√º g√∂r</div>
                ${p.comment ? `<div class="post-comments">${p.comment}</div>` : ''}
                <div class="post-time">${p.time}</div>
            `;
            container.appendChild(el);
        });

        // REELS OLU≈ûTURMA FONKSƒ∞YONU VE PULL-TO-REFRESH MANTIƒûI
        let currentReelList = [];

        // Observer tanƒ±mlarƒ± (Daha √∂nce global tanƒ±mlanmalƒ± ki fonksiyon i√ßinde kullanƒ±labilsin)
        const reelsObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target.querySelector('.reel-video');
                if (!video) return;
                if (entry.isIntersecting) {
                    video.preload = "auto";
                    video.currentTime = 0;
                    video.muted = false; 
                    video.play().catch(e => console.log("Reel autoplay engellendi"));
                    const nextReel = entry.target.nextElementSibling;
                    if (nextReel) {
                        const nextVideo = nextReel.querySelector('.reel-video');
                        if (nextVideo) nextVideo.preload = "auto";
                    }
                } else {
                    video.pause();
                    video.currentTime = 0;
                    video.preload = "none";
                }
            });
        }, { threshold: 0.6 });

        // Reels verilerini ekrana basan fonksiyon
        function renderReelsData() {
            reelsView.innerHTML = ''; // Mevcut i√ßeriƒüi temizle
            
            // Listeyi karƒ±≈ütƒ±r
            reels.sort(() => Math.random() - 0.5).forEach(r => {
                const el = document.createElement('div');
                el.className = 'reel-container';
                el.innerHTML = `
                    <video class="reel-video reel-bg" src="${r.video}" loop playsinline preload="none"></video>
                    <div class="reel-overlay"></div>
                    <div class="reel-loader"></div>
                    <div class="volume-icon">üîá</div>
                    <div class="reel-actions">
                        <button class="reel-btn" onclick="likeReel(this)">ü§ç <span>${r.likes}</span></button>
                        <button class="reel-btn">üí¨ <span>${r.comments}</span></button>
                        <button class="reel-btn">üì§ <span>Payla≈ü</span></button>
                        <button class="reel-btn">‚ãØ</button>
                    </div>
                    <div class="reel-info">
                        <div class="reel-user">
                            <div class="reel-avatar" style="background-image:url('${r.avatar}')"></div>
                            <span class="reel-username">${r.user}</span>
                            <button class="reel-follow">Takip Et</button>
                        </div>
                        <div class="reel-description">${r.desc}</div>
                        <div class="music-ticker">üéµ Orijinal Ses - ${r.user}</div>
                    </div>
                `;
                
                // Eventleri ve G√∂zlemciyi yeniden baƒüla
                setupReelEvents(el);
                attachDoubleTap(el);
                reelsObserver.observe(el);
                reelsView.appendChild(el);
            });

            // Sonsuz d√∂ng√º listesini g√ºncelle
            currentReelList = Array.from(document.querySelectorAll('.reel-container'));
        }

        // Ba≈ülangƒ±√ßta Reels'leri y√ºkle
        renderReelsData();

        // Reels Eventlerini Ayarlayan Fonksiyon
        function setupReelEvents(container) {
            const video = container.querySelector('.reel-video');
            const loader = container.querySelector('.reel-loader');
            const volumeIcon = container.querySelector('.volume-icon');

            // 1. Loading Durumu (Buffering)
            video.addEventListener('waiting', () => {
                loader.style.display = 'block';
            });
            video.addEventListener('playing', () => {
                loader.style.display = 'none';
            });

            // 2. Tƒ±klayƒ±nca Ses A√ß/Kapat (Toggle Mute)
            container.addEventListener('click', (e) => {
                // Eƒüer butonlara tƒ±klanƒ±rsa √ßalƒ±≈ümasƒ±n
                if (e.target.closest('.reel-btn') || e.target.closest('.reel-follow')) return;

                // Ses durumunu deƒüi≈ütir
                video.muted = !video.muted;
                
                // ƒ∞konu g√∂ster
                volumeIcon.textContent = video.muted ? "üîá" : "üîä";
                volumeIcon.classList.add('show');
                
                // 1 saniye sonra ikonu gizle
                setTimeout(() => {
                    volumeIcon.classList.remove('show');
                }, 1000);
            });
        }

        let soundEnabled = false, currentPostList = [];
        
        const tips = [
            "Sude Naz T. bu projeye 60 saatten fazla zaman harcadƒ±.",
            "Bur√ßin hoca bizce bize y√ºksek not verecek ‚ù§Ô∏è", 
            "Dengeli beslenmek i√ßin bir diyetisyenle g√∂r√º≈ü√ºn.",
            "Stomalƒ± bireyler gaz √ßƒ±kƒ±≈üƒ±nƒ± kontrol edemez.",
            "Stoma varlƒ±ƒüƒ± bir hastalƒ±k deƒüildir.",
            "Stoma bakƒ±mƒ±nƒ± aksatmayƒ±nƒ±z.",
            "Dengeli beslenmek saƒülƒ±ƒüƒ±n temelidir.",
            "Her g√ºn 1-2L su i√ßmek saƒülƒ±ƒüa yararlƒ±dƒ±r.",
            "Stomanƒ±zla barƒ±≈üƒ±k olun. (opsiyonel)",
            "Y√ºkleme ekranƒ±nda 10 farklƒ± bilgi vardƒ±r."
        ];
        
        let tipIndex = 0, tipInterval;
        
        function displayTip() {
            const el = document.getElementById('loading-tip');
            el.style.opacity = 0;
            setTimeout(() => {
                el.innerHTML = `<strong>Bunu Biliyor Muydunuz:</strong> ${tips[tipIndex]}`;
                el.style.opacity = 1;
                tipIndex = (tipIndex + 1) % tips.length;
            }, 500);
        }

        const initialEl = document.getElementById('loading-tip');
        initialEl.innerHTML = `<strong>Bunu Biliyor Muydunuz:</strong> ${tips[0]}`;
        initialEl.style.opacity = 1;
        tipIndex = 1;

        tipInterval = setInterval(displayTip, 2500);

        window.addEventListener('load', () => {
            const preloader = document.getElementById('preloader');
            const mainContent = document.getElementById('main-content');
            const videosToPreloadCount = 2;
            const allReels = document.querySelectorAll('.reel-video');
            let loadedCount = 0, appStarted = false;

            function startApp() {
                if (appStarted) return;
                appStarted = true;
                if (tipInterval) clearInterval(tipInterval);
                mainContent.style.display = 'flex';
                preloader.classList.add('hidden');
                setTimeout(() => preloader.style.display = 'none', 500);
            }

            function checkVideoLoaded() {
                loadedCount++;
                if (loadedCount >= videosToPreloadCount) startApp();
            }

            if (allReels.length === 0) {
                startApp();
            } else {
                const limit = Math.min(allReels.length, videosToPreloadCount);
                for (let i = 0; i < limit; i++) {
                    const video = allReels[i];
                    video.preload = "auto";
                    video.onloadeddata = checkVideoLoaded;
                    if (video.readyState >= 3) checkVideoLoaded();
                }
            }
            setTimeout(() => { if (!appStarted) startApp(); }, 5000);
        });

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        function updateOnlineStatus() {
            document.getElementById('offline-banner').style.display = !navigator.onLine ? 'block' : 'none';
        }
        updateOnlineStatus();

        function updateTime() {
            const el = document.getElementById("time");
            const now = new Date();
            let h = now.getHours(), m = now.getMinutes();
            if (h < 10) h = "0" + h;
            if (m < 10) m = "0" + m;
            el.textContent = h + ":" + m;
        }
        updateTime();
        setInterval(updateTime, 1000);

        function toggleFollow(btn) {
            btn.classList.toggle('following');
            btn.textContent = btn.classList.contains('following') ? 'Takip Ediliyor' : 'Takip Et';
            btn.style.color = btn.classList.contains('following') ? '#a8a8a8' : '#0095f6';
            event.stopPropagation();
        }

        function likePost(btn) {
            btn.classList.toggle("liked");
            const likesSpan = btn.closest('.post').querySelector('.likes-count');
            let count = parseInt(likesSpan.textContent.replace(/,/g, ''));
            if (btn.classList.contains("liked")) {
                btn.textContent = "‚ù§Ô∏è";
                count += 1;
            } else {
                btn.textContent = "ü§ç";
                count -= 1;
            }
            likesSpan.textContent = count.toLocaleString();
        }

        function toggleSave(btn) {
            const isSaved = btn.classList.toggle('saved');
            btn.textContent = isSaved ? 'üè∑Ô∏è' : 'üîñ';
        }

        function likeReel(btn) {
            btn.classList.toggle("liked");
            let textSpan = btn.querySelector('span');
            let text = textSpan.textContent;
            if (btn.classList.contains("liked")) {
                btn.innerHTML = `‚ù§Ô∏è <span>${text}</span>`;
                btn.style.color = '#ed4956';
            } else {
                btn.innerHTML = `ü§ç <span>${text}</span>`;
                btn.style.color = '#fff';
            }
        }

        function showHeart(el) {
            let heart = document.createElement('div');
            heart.className = 'double-heart';
            heart.innerHTML = '‚ù§Ô∏è';
            el.appendChild(heart);
            void heart.offsetWidth;
            heart.classList.add('show');
            setTimeout(() => {
                heart.classList.remove('show');
                setTimeout(() => { if (heart.parentElement) heart.parentElement.removeChild(heart); }, 500);
            }, 800);
        }

        function attachDoubleTap(el) {
            let lastTap = 0;
            el.addEventListener('dblclick', (e) => {
                showHeart(el);
                const post = el.closest('.post');
                const reel = el.closest('.reel-container');
                if (post) {
                    const likeBtn = post.querySelector('.action-group .action-btn');
                    if (likeBtn && !likeBtn.classList.contains('liked')) likePost(likeBtn);
                }
                if (reel) {
                    const likeBtn = reel.querySelector('.reel-actions .reel-btn:first-child');
                    if (likeBtn && !likeBtn.classList.contains('liked')) likeReel(likeBtn);
                }
            });
            el.addEventListener('touchend', function(e) {
                const currentTime = Date.now();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                    showHeart(el);
                    const post = el.closest('.post');
                    const reel = el.closest('.reel-container');
                    if (post) {
                        const likeBtn = post.querySelector('.action-group .action-btn');
                        if (likeBtn && !likeBtn.classList.contains('liked')) likePost(likeBtn);
                    }
                    if (reel) {
                        const likeBtn = reel.querySelector('.reel-actions .reel-btn:first-child');
                        if (likeBtn && !likeBtn.classList.contains('liked')) likeReel(likeBtn);
                    }
                }
                lastTap = currentTime;
            });
        }
        document.querySelectorAll('.post-content').forEach(el => attachDoubleTap(el));
        
        // Reels i√ßin attachDoubleTap fonksiyonu zaten renderReelsData i√ßinde √ßaƒürƒ±lƒ±yor.

        const soundToggle = document.getElementById("soundToggle");
        const postsContainer = document.getElementById("postsContainer");

        function managePostAudio(post, shouldPlay) {
            if (document.getElementById('reels-view').style.display === 'block') return;
            const audio = post.querySelector(".post-audio");
            if (!audio) return;
            if (shouldPlay) {
                audio.muted = !soundEnabled;
                audio.volume = 0.6;
                audio.play().catch(e => console.log("Oynatma engellendi"));
            } else {
                audio.pause();
                audio.currentTime = 0;
            }
        }

        const feedObserver = new IntersectionObserver(entries => {
            entries.forEach(entry => managePostAudio(entry.target, entry.isIntersecting));
        }, { threshold: 0.6 });
        document.querySelectorAll('.post').forEach(post => feedObserver.observe(post));

        soundToggle.addEventListener("click", () => {
            soundEnabled = !soundEnabled;
            soundToggle.textContent = soundEnabled ? "üîä" : "üîá";
            document.querySelectorAll(".post").forEach(post => {
                const rect = post.getBoundingClientRect();
                if (rect.bottom > 0 && rect.top < window.innerHeight) managePostAudio(post, true);
            });
        });

        const navButtons = document.querySelectorAll(".nav-btn");
        const searchPopup = document.getElementById("searchPopup");
        const reelsViewEl = document.getElementById("reels-view");
        const mainHeader = document.getElementById("mainHeader");

        navButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const action = btn.getAttribute("data-action");
                if (action === "search") {
                    searchPopup.style.display = "flex";
                    return;
                }
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll(".post-audio").forEach(a => { a.pause(); a.currentTime = 0; });
                document.querySelectorAll(".reel-video").forEach(v => { v.pause(); v.currentTime = 0; });
                if (action === "home") {
                    postsContainer.style.display = "block";
                    reelsViewEl.style.display = "none";
                    mainHeader.style.display = "flex";
                    postsContainer.scrollTo({ top: 0, behavior: 'smooth' });
                } else if (action === "reels") {
                    postsContainer.style.display = "block";
                    reelsViewEl.style.display = "block";
                    mainHeader.style.display = "none";
                    reelsViewEl.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    navButtons.forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-action="home"]').classList.add('active');
                }
            });
        });

        function closeSearch() { searchPopup.style.display = "none"; }

        function closeSoundTutorial() {
            document.getElementById("soundTutorialOverlay").style.display = "none";
            soundToggle.style.animation = "none";
            document.body.style.overflow = '';
            localStorage.setItem('soundTutorialShown', 'true');
        }

        window.addEventListener('load', () => {
            if (localStorage.getItem('soundTutorialShown') !== 'true') {
                setTimeout(() => {
                    soundToggle.textContent = "üîá";
                    soundToggle.style.animation = "pulse 1.5s infinite";
                    document.getElementById("soundTutorialOverlay").style.display = "flex";
                    document.body.style.overflow = 'hidden';
                }, 500);
            }
        });

        const MAX_LENGTH = 55;
        function initializeCaptionTruncation() {
            document.querySelectorAll('.post-caption').forEach(captionDiv => {
                const textNode = captionDiv.querySelector('.caption-text');
                if (!textNode) return;
                const rawText = textNode.textContent.trim();
                captionDiv.setAttribute('data-full-text', rawText);
                if (rawText.length <= MAX_LENGTH) return;
                const truncatedText = rawText.substring(0, MAX_LENGTH) + '...';
                textNode.textContent = truncatedText;
                const readMoreBtn = document.createElement('span');
                readMoreBtn.className = 'read-more-btn';
                readMoreBtn.textContent = 'devamƒ±nƒ± oku';
                readMoreBtn.onclick = function(e) {
                    const isExpanded = captionDiv.classList.toggle('expanded');
                    if (isExpanded) {
                        textNode.textContent = rawText;
                        readMoreBtn.textContent = 'gizle';
                    } else {
                        textNode.textContent = truncatedText;
                        readMoreBtn.textContent = 'devamƒ±nƒ± oku';
                    }
                    e.stopPropagation();
                };
                captionDiv.appendChild(readMoreBtn);
            });
        }
        window.addEventListener('load', initializeCaptionTruncation);

        setTimeout(() => { currentPostList = Array.from(document.querySelectorAll('.post')); }, 300);
        
        // currentReelList, renderReelsData i√ßinde atanƒ±yor.

        postsContainer.addEventListener('scroll', () => {
            if (postsContainer.scrollTop + postsContainer.clientHeight >= postsContainer.scrollHeight - 800) {
                currentPostList.forEach(originalPost => {
                    const clone = originalPost.cloneNode(true);
                    feedObserver.observe(clone);
                    attachDoubleTap(clone.querySelector('.post-content'));
                    const saveBtn = clone.querySelector('.action-btn:last-child');
                    if (saveBtn) {
                        saveBtn.classList.remove('saved');
                        saveBtn.textContent = 'üîñ';
                    }
                    container.appendChild(clone);
                });
            }
        });

        reelsViewEl.addEventListener('scroll', () => {
            if (reelsViewEl.scrollTop + reelsViewEl.clientHeight >= reelsViewEl.scrollHeight - 400) {
                currentReelList.forEach(originalReel => {
                    const clone = originalReel.cloneNode(true);
                    const video = clone.querySelector('.reel-video');
                    if (video) {
                        video.pause();
                        video.currentTime = 0;
                        video.muted = true;
                        video.preload = "none";
                    }
                    reelsObserver.observe(clone);
                    setupReelEvents(clone); 
                    attachDoubleTap(clone);
                    reelsView.appendChild(clone);
                });
            }
        });

        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                document.querySelectorAll(".post-audio").forEach(a => { a.pause(); a.currentTime = 0; });
                document.querySelectorAll(".reel-video").forEach(v => { v.pause(); v.currentTime = 0; });
            } else {
                if (reelsViewEl.style.display !== 'block' && soundEnabled) {
                    document.querySelectorAll('.post').forEach(post => {
                        const rect = post.getBoundingClientRect();
                        if (rect.bottom > 0 && rect.top < window.innerHeight) managePostAudio(post, true);
                    });
                }
            }
        });

        let startY = 0, isPulling = false;
        postsContainer.addEventListener("touchstart", (e) => {
            if (postsContainer.scrollTop === 0) {
                startY = e.touches[0].clientY;
                isPulling = true;
            }
        });
        postsContainer.addEventListener("touchmove", (e) => {
            if (!isPulling) return;
            let currentY = e.touches[0].clientY;
            if ((currentY - startY) > 80) { location.reload(); isPulling = false; }
        });
        postsContainer.addEventListener("touchend", () => { isPulling = false; });

        document.querySelectorAll(".action-btn").forEach(btn => {
            if (btn.textContent.includes("üì§")) {
                btn.addEventListener("click", async () => {
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: "Stomagram Postu",
                                text: "Buna bir g√∂z at! üëÄ",
                                url: window.location.href
                            });
                        } catch (err) { console.log("Payla≈üƒ±m iptal edildi:", err); }
                    } else { alert("Cihazƒ±nƒ±z payla≈üƒ±mƒ± desteklemiyor."); }
                });
            }
        });

        /* --- REELS PULL-TO-REFRESH MANTIƒûI --- */
        const reelsLoader = document.getElementById('reels-refresh-loader');
        let reelStartY = 0;
        let isReelPulling = false;

        reelsView.addEventListener('touchstart', (e) => {
            if (reelsView.scrollTop === 0) {
                reelStartY = e.touches[0].clientY;
                isReelPulling = true;
            }
        }, {passive: true});

        reelsView.addEventListener('touchmove', (e) => {
            if (!isReelPulling) return;
            const currentY = e.touches[0].clientY;
            const pullDistance = currentY - reelStartY;

            if (pullDistance > 0 && reelsView.scrollTop === 0) {
                if (pullDistance > 60) {
                    reelsLoader.classList.add('visible');
                    if (navigator.vibrate && pullDistance === 61) navigator.vibrate(10);
                } else {
                    reelsLoader.classList.remove('visible');
                }
            } else {
                isReelPulling = false;
            }
        }, {passive: true});

        reelsView.addEventListener('touchend', (e) => {
            if (!isReelPulling) return;
            isReelPulling = false;
            if (reelsLoader.classList.contains('visible')) {
                reelsLoader.classList.remove('visible');
                reelsLoader.classList.add('spinning'); 

                setTimeout(() => {
                    renderReelsData(); 
                    reelsLoader.classList.remove('spinning');
                    const firstVideo = document.querySelector('.reel-container:first-child .reel-video');
                    if(firstVideo) {
                        firstVideo.play().catch(()=>{});
                        firstVideo.muted = false;
                    }
                }, 1200);
            }
        });
    </script>
</body>
</html>



